#!/bin/bash
set -euo pipefail

# Auto-deploy on commit: infra + app based on current branch

BRANCH=$(git rev-parse --abbrev-ref HEAD)
REPO_ROOT=$(git rev-parse --show-toplevel)
echo "ðŸ”„ Post-commit hook: Branch '$BRANCH' â†’ auto-deploy from $REPO_ROOT"

case "$BRANCH" in
  "production")
    ENV="prod"
    ;;
  "develop")
    ENV="staging"
    ;;
  *)
    echo "   â†’ Skipping auto-deploy for branch '$BRANCH' (use manual ./scripts/deploy-app.sh feature/$BRANCH)"
    exit 0
    ;;
esac

echo "   â†’ Environment: $ENV"

# Deploy infra (idempotent)
"$REPO_ROOT/scripts/deploy-infra.sh" "$ENV"

# Deploy app
"$REPO_ROOT/scripts/deploy-app.sh" "$ENV"

echo "âœ… Auto-deploy complete for $ENV!"
